---
title: "안드로이드 프래그먼트"
excerpt: "안드로이드 프래그먼트 생성과 이벤트 핸들러 및 트랜잭션"
classes: wide
categories: 
  - Android
tag:
  - android
  - fragment
read_time: false
last_modified_at: 2020-03-12T17:38:00+09:00
toc: true
---

## 프래그먼트

프래그먼트는 완벽하게 **캡슐화** 되었고 **재사용**할 수 있는 컴포넌트들로 **액티비티**를 **분할**해 준다. 각 프래그먼트는 수명 주기와 상태를 따로 갖는다.

각 프래그먼트는 독립적인 모듈로, 자신이 추가된 액티비티와 느슨하게 결합되지만 강하게 종속된다. 프래그먼트는 UI를 포함하거나 또는 포함하지 않을 수 있으며, 여러 액티비티 안에서 사용될 수 있다. UI가 캡슐화된 프래그먼트는 다양하게 조합돼 여러 패널을 갖는 UI에 적합하도록 배치될 수 있으며, 실행 중인 액티비티 안에 추가, 제거 또는 교환돼 동적인 UI를 빌드하는 데 사용될 수도 있다.

액티비티를 프래그먼트로 나눌 필요가 없더라도 나눈다면 UI의 유연성이 현저하게 높아지며, 사용자 경험을 새 기기 구성에 더 쉽게 적용할 수 있다.

액티비티는 매니페스트 파일에 등록되어 있어야 하지만 프래그먼트는 액티비티에 내장될 때만 존재할 수 있기 때문에 프래그먼트는 등록하지 않아도 된다. 따라서 프래그먼트의 수명 주기는 자신이 추가된 액티비티의 수명 주기에 종속된다.



## 프래그먼트 수명 주기

프래그먼트의 수명 주기 이벤트는 자신의 **부모 액티비티 수명주기**를 따른다. 그러나 부모 액티비티가 활성 상태가 된 이후에 프래그먼트를 추가 또는 삭제하는 것은 프래그먼트의 수명 주기에만 영향을 준다.

 Activity 클래스의 이벤트 핸들러를 따라 동작하는 **이벤트 핸들러**들이 프래그먼트에도 마찬가지로 존재한다. 해당 핸들러들은 프래그먼트의 생성, 시작, 재개, 일시 정지, 정지, 소멸에 맞춰 자동 실행된다.



## 프래그먼트 전용 수명주기 이벤트

프래그먼트의 수명 주기 이벤트들은 대부분 Activity 클래스의 해당 이벤트와 짝을 이룬다. 프래그먼트에서만 제공되는 이벤트들은 다음과 같다.

- **부모 컨텍스트에서 프래그먼트 연결하기와 분리하기**
  프래그먼트의 전체 수명은 부모 컨텍스트에서 바인딩될 때부터 분리될 때 까지다. 이 두 이벤트는 각각  onAttach와 onDetach의 호출로 표현된다.
  - **onAttach**
     : 프래그먼트의 UI가 생성되기 전, 그리고 프래그먼트 자체 또는 그 부모의 초기화가 완료되기 전에 발생된다. 일반적으로 onAttach 이벤트는 향후의 초기화 작업을 대비하여 부모 컴포넌트의 컨텍스트 참조를 얻기 위해 사용된다.
  - **onDetach**
     : 프래그먼트를 부모로부터 제거할 때와 프래그먼트가 포함된 컴포넌트가 소멸될 때 호출된다. 프래그먼트/액티비티가 일시 정지된 이후에 호출되는 여느 핸들러처럼 onDetach 또한 부모 컴포넌트의 프로세스가 전체 수명 주기를 완료하지 않은 채 중단된다면 호출되지 않는다.

- **프래그먼트 생성하기와 소멸시키기**
  프래그먼트의 수명은 onCreate가 처음 호출된 때부터 onDestroy가 마지막으로 호출될 때까지다. 

  액티비티의 프로세스가 중단될 때 프래그먼트의 onDestoy 메서드가 호출되지 않는 경우도 많기 때문에 프래그먼트를 클린업하는 작업을 onDestroy에 의존하면 안된다. 액티비티처럼 프래그먼트의 초기화는 onCreate 메서드에서 한다. 또한 프래그먼트 클래스에서만 사용되는 객체들은 프래그먼트의 수명 동안에 한 번만 생성되도록 하는 것이 좋다.

- **UI 생성하기와 소멸시키기**
  프래그먼트의 UI는 onCreateView 에서 초기화 되고 onDestroyView에서 소멸된다. 

  프래그먼트를 초기화할 때는 onCreateView 메서드를 사용한다. 좀 더 구체적으로는 UI를 인플레이트하고 UI에 포함된 모든 뷰의 참조를 얻고 데이터를 지정한다. 끝으로 UI의 뷰 계층 구조를 나타내는 프래그먼트 레이아웃을 인플레이트하고 반환해야 한다. 만일 프래그먼트가 부모 액티비티의 UI와 상호 작용하는 것이 있다면 onActivityCreated에서 처리한다. 해당 프래그먼트를 포함하는 액티비티가 초기화 및 자신의 UI 생성을 완료했을 때 onActivityCreated가 호출되기 때문이다.

  

## 프래그먼트의 상태들

프래그먼트는 액티비티처럼 포그라운드에서 포커스를 받고 있는 액티비티에 속할 때 ‘활성’ 상태가 된다. 액티비티가 (일시)정지되면 자신에게 포함된 프래그먼트 또한 정지되며, 비활성 액티비티에 포함된 프래그먼트로 비활성 상태가 된다. 액티비티가 최종적으로 소멸할 때 자신에 포함된 각 프래그먼트도 소멸된다.

액티비티와 프래그먼트는 강하게 결합되어 있지만 프래그먼트를 사용하면 장점이 있다. 즉 액티비티를 동적으로 프래그먼트를 추가 또는 삭제하여 유연하게 액티비티 UI를 구성할 수 있다. 따라서 각 프래그먼트는 자신의 수명 주기를 부모 액티비티의 활성 수명 동안 여러 번 거칠 수 있다.



## 프래그먼트 매니저

액티비티는 자신이 포함하는 프래그먼트를 관리하기 위해 프래그먼트 매니저를 갖는다. ASL을 사용하고 있으므로 **getSupportFragmentManager** 메서드를 사용해서 프래그먼트 매니저의 참조를 얻는다. 액티비티에 추가된 프래그먼트에 접근하고, 프래그먼트의 추가, 제거, 교체를 하기 위해 프래그먼트 트랜잭션을 수행하는 데 사용되는 메서드들을 프래그먼트 매니저가 제공한다.



## 프래그먼트 트랜잭션

프래그먼트 트랜잭션은 런타임 시에 액티비티 안에서 프래그먼트를 추가, 제거, 교체할 때 사용된다. 프래그먼트 트랜잭션을 사용하면 동적인 레이아웃을 만들 수 있다. 동적인 레이아웃은 사용자와의 상호작용과 애플리케이션 상태에 적응해 변경된다. 새 프래그먼트 트랜잭션을 생성할 때는 프래그먼트 매니저의 beginTransction() 메서드를 호출한다. 그 다음에 add, remove, replace 메서드를 사용해서 원하는 대로 레이아웃을 변경한 후 프래그먼트를 화면에 보여주거나 백 스택에 추가한다. 그리고 마지막으로 commit 을 호출하여 트랜잭션이 비동기적으로 실행되도록 UI큐에 추가하거나, 또는 commitNow를 호출해 트랜잭션이 실행되어 완료될 때까지 다른 작업에 의해 방해받지 않게 한다.



## 프래그먼트 추가, 제거, 교체

- **추가(add)**
  새 UI 프래그먼트를 추가하려면 우선 프래그먼트부터 새로 만들고 이 프래그먼트가 놓이게 될 컨테이너 뷰와 함께 프래그먼트 트랜잭션의 add 메서드에 전달해야 한다. 그리고 선택적이지만 프래그먼트 태그를 지정하여 findFragmentByTag 메서드를 호출하여 프래그먼트를 찾는 데 사용할 수 있다.

``` java
FragmentManager fragmentManager = getSupportFragmentManager();
FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
fragmentTransaction.add(R.id.details_container, new DetailFragment()); fragmentTransaction.commitNow();
```

- **제거(remove)**
  프래그먼트를 제거할 때는 프래그먼트의 참조부터 찾아야 한다. 이때 프래그먼트 매니저의 findFragmentById 메서드나 findFragmentByTag 메서드를 사용한다. 그 다음에 찾은 프래그먼트 인스턴스를 프래그먼트 트랜잭션의 remove 메서드 매개변수로 전달한다.

- **교체(replace)**
  한 프래그먼트를 다른 것으로 교체할 수도 있다. 이때는 replace 메서드를 사용하며, 교체될 프래그먼트가 포함된 컨테이너 ID 와 교체되는 새 프래그먼트, 새로 삽입되는 프래그먼트를 식별하는 태그를 replace 메서드의 인자로 전달한다.



## 프래그먼트와 구성 변경

안드로이드 기기의 구성이 변경될 때 변함없는 UI 상태를 유지하기 위해서는 화면의 방향 변경이나 예기치 않은 액티비티 중단으로 인해 액티비티 인스턴스가 다시 생성도리 때 UI에 추가된 모든 프래그먼트가 자동으로 복구돼야 한다.

이 작업은 onCreate에서 액티비티 레이아웃에 프래그먼트를 추가하는 경우에 특히 중요하다. 이때는 같은 프래그먼트 인스턴스가 여러 개 추가되지 않도록 해당 프래그먼트가 이미 추가되었는지 반드시 확인해야 한다.

이 작업을 위해서는 프래그먼트를 추가하기 전에 확인하거나, savedInstatnceState가 null인지 검사하여 액티비티가 다시 시작된 것인지 확인하여 처리할 수 있다.